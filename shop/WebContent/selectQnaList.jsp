<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="vo.*" %>
<%@ page import="dao.*" %>
<%@ page import="java.util.*" %>

<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <title>Ï†ÑÏûêÏ±Ö ÏÉÅÏ†ê</title>
</head>
<body>
<%
	request.setCharacterEncoding("utf-8");
	
	Member loginMember = null;
	if(session.getAttribute("loginMember")!=null){
		loginMember = (Member)session.getAttribute("loginMember");
	}
	
	// ÌéòÏù¥ÏßÄ
	int currentPage = 1;
	if(request.getParameter("currentPage")!=null){
		currentPage = Integer.parseInt(request.getParameter("currentPage"));
	}
	System.out.println(currentPage+" <--ÏßàÎ¨∏ Î™©Î°ù currentPage");
	
	final int ROW_PER_PAGE = 10; // ÌéòÏù¥ÏßÄÏóê Î≥¥Ïùº ÏßàÎ¨∏ Í∞úÏàò
	int  beginRow = (currentPage-1)*ROW_PER_PAGE; // ÏßàÎ¨∏ Î™©Î°ù ÏãúÏûë Î∂ÄÎ∂Ñ
	
	// ÏßàÎ¨∏ Î™©Î°ùÏùÑ Î¶¨Ïä§Ìä∏Ïóê Îã¥Í∏∞
	QnaDao qnaDao = new QnaDao();
	Map<String,Object> map = qnaDao.selectQnaJoinCommentList(beginRow,ROW_PER_PAGE);
	ArrayList<Qna> qnaList = (ArrayList<Qna>)map.get("qnaList");
	ArrayList<QnaComment> qnaCommentList = (ArrayList<QnaComment>)map.get("qnaCommentList");
%>

   <!-- start : submenu include -->
   <div>
      <jsp:include page="/partial/mainMenu.jsp"></jsp:include>
   </div>
   <!-- end : submenu include -->
   <br>
	
	<div class="page-center">
	<table class="table">
		<thead>
			<tr>
				<th>QnA</th>
			</tr>
		</thead>
		<tbody>
		<tr>
			<td>
			<%
				// Î∞òÎ≥µÏùÑ ÌÜµÌï¥ ÏßàÎ¨∏ Î™©Î°ùÏùÑ ÌëúÎ°ú Ï∂úÎ†•
				for(int i=0; i<qnaList.size();i++){
					Qna qna = qnaList.get(i);
					QnaComment qnaComment = qnaCommentList.get(i);
					
					// ÎßåÏïΩ ÎπÑÎ∞ÄÍ∏ÄÏù¥ÎùºÎ©¥
					if(qna.getQnaSecret().equals("Y")){
						// ÎßåÏïΩ ÎπÑÎ∞ÄÍ∏ÄÏùò ÏûëÏÑ±ÏûêÍ∞Ä Î≥∏Ïù∏Ïù¥ÎùºÎ©¥ ÎπÑÎ∞ÄÍ∏ÄÏù¥ÎùºÎèÑ ÏÉÅÏÑ∏Î≥¥Í∏∞Í∞Ä Í∞ÄÎä•ÌïòÎèÑÎ°ù ÌïúÎã§.
						if(loginMember!=null && qna.getMemberId().equals(loginMember.getMemberId())){
						%>
							<div class="card">
							    <div class="card-header" id="heading<%=qna.getQnaNo() %>">
							      <h5 class="mb-0">
							        <button class="btn btn-link" data-toggle="collapse" data-target="#<%=qna.getQnaNo() %>" aria-controls="<%=qna.getQnaNo() %>">
							          üîë [<%=qna.getQnaCategory() %>] <%=qna.getQnaTitle() %> - <%=qna.getMemberId() %>
							        </button>
							      </h5>
							    </div>
							
							    <div id="<%=qna.getQnaNo() %>" class="collapse" aria-labelledby="heading<%=qna.getQnaNo() %>" data-parent="#accordion">
							      <div class="card-body">
							      	<p>[ÏßàÎ¨∏]</p>
							        <%=qna.getQnaContent() %>
							        <p class="size-10">ÏûëÏÑ±Ïùº : <%=qna.getCreateDate().substring(0,10) %></p>
							        
							        <%
							        	if(qnaComment.getQnaCommentContent()!=null && qnaComment.getQnaCommentContent()!=""){
					        		%>
					        			<br><br><br>
								        <p>[ÎãµÎ≥Ä]</p>
								        <%=qnaComment.getQnaCommentContent() %>
								        <p class="size-10">ÎãµÎ≥ÄÏùº : <%=qnaComment.getCreateDate().substring(0,10) %></p>
					        		<%
							        	}
							        %>
					    			<table>
					    				<tr>
					    					<td>
					    						<!-- ÏßàÎ¨∏ ÏàòÏ†ï Î≤ÑÌäº -->
					    						<form action="<%=request.getContextPath() %>/updateQnaForm.jsp" id="updateQnaForm" method="post">
					    							<input type="hidden" value="<%=qna.getQnaNo() %>" name="qnaNo">
					    							<button class="btn btn-secondary" type="submit" id="updateBtn">ÏßàÎ¨∏ÏàòÏ†ï</button>
					    						</form>
					    					</td>
					    					<td>
					    						<!-- ÏßàÎ¨∏ ÏÇ≠Ï†ú Î≤ÑÌäº -->
					    						<form action="<%=request.getContextPath() %>/deleteQna.jsp" id="deleteQnaForm" method="post">
					    							<input type="hidden" value="<%=qna.getQnaNo() %>" name="qnaNo">
					    							<button class="btn btn-danger" type="submit" id="deleteBtn">ÏßàÎ¨∏ÏÇ≠Ï†ú</button>
					    						</form>
					    					</td>
					    				</tr>
					    			</table>
							      </div>
							    </div>
							 </div>
							
						<%
						} else{ // ÏÉÅÏÑ∏Î≥¥Í∏∞Îäî Î∂àÍ∞ÄÎä•ÌïòÎèÑÎ°ù ÌïúÎã§.
						%>
								<div class="card">
							    <div class="card-header" id="heading<%=qna.getQnaNo() %>">
							      <h5 class="mb-0">
							        <button class="btn btn-link" data-toggle="collapse" data-target="#<%=qna.getQnaNo() %>" aria-controls="<%=qna.getQnaNo() %>">
							          üîë [<%=qna.getQnaCategory() %>] <%=qna.getQnaTitle() %> - <%=qna.getMemberId() %>
							        </button>
							      </h5>
							    </div>
							 </div>
						<%
						}
					} else{ // ÎπÑÎ∞ÄÍ∏ÄÏù¥ ÏïÑÎãàÎùºÎ©¥
					%>
							<div class="card">
							    <div class="card-header" id="heading<%=qna.getQnaNo() %>">
							      <h5 class="mb-0">
							        <button class="btn btn-link" data-toggle="collapse" data-target="#<%=qna.getQnaNo() %>" aria-controls="<%=qna.getQnaNo() %>">
							          [<%=qna.getQnaCategory() %>] <%=qna.getQnaTitle() %> - <%=qna.getMemberId() %>
							        </button>
							      </h5>
							    </div>
							
							    <div id="<%=qna.getQnaNo() %>" class="collapse" aria-labelledby="heading<%=qna.getQnaNo() %>" data-parent="#accordion">
							      <div class="card-body">
							      	<p>[ÏßàÎ¨∏]</p>
							        <%=qna.getQnaContent() %>
							        <p class="size-10">ÏûëÏÑ±Ïùº : <%=qna.getCreateDate().substring(0,10) %></p>
							        
							        <%
							        	if(qnaComment.getQnaCommentContent()!=null && qnaComment.getQnaCommentContent()!=""){
					        		%>
					        			<br><br><br>
								        <p>[ÎãµÎ≥Ä]</p>
								        <%=qnaComment.getQnaCommentContent() %>
								        <p class="size-10">ÎãµÎ≥ÄÏùº : <%=qnaComment.getCreateDate().substring(0,10) %></p>
					        		<%
							        	}
							        %>
							        <%
										if(loginMember!=null && loginMember.getMemberId().equals(qna.getMemberId())){
										%>
											<table>
												<tr>
													<td>
														<!-- ÏßàÎ¨∏ ÏàòÏ†ï Î≤ÑÌäº -->
														<form action="<%=request.getContextPath() %>/updateQnaForm.jsp" id="updateQnaForm" method="post">
															<input type="hidden" value="<%=qna.getQnaNo() %>" name="qnaNo">
															<button class="btn btn-secondary" type="submit" id="updateBtn">ÏßàÎ¨∏ÏàòÏ†ï</button>
														</form>
													</td>
													<td>
														<!-- ÏßàÎ¨∏ ÏÇ≠Ï†ú Î≤ÑÌäº -->
														<form action="<%=request.getContextPath() %>/deleteQna.jsp" id="deleteQnaForm" method="post">
															<input type="hidden" value="<%=qna.getQnaNo() %>" name="qnaNo">
															<button class="btn btn-danger" type="submit" id="deleteBtn">ÏßàÎ¨∏ÏÇ≠Ï†ú</button>
														</form>
													</td>
												</tr>
											</table>
										<%
										}
									%>
							      </div>
							    </div>
							 </div>
					<%	
					}
				}
			%>
			</td>
			</tr>
		</tbody>
	</table>
	<%
		if(session.getAttribute("loginMember")!=null){
	%>
			<!-- ÏßàÎ¨∏ Ï∂îÍ∞Ä Î≤ÑÌäº -->
			<form action="<%=request.getContextPath() %>/insertQnaForm.jsp" id="insertQnaForm" method="post">
				<button class="btn btn-secondary" type="button" id="insertBtn">ÏÉàÏßàÎ¨∏</button>
			</form>
	<%
		}
	%>
	
	<br><br>
	
	<!-- ÌéòÏù¥ÏßÄ -->
   <%	
   	   // ÌéòÏù¥ÏßïÏùÑ ÏúÑÌï¥ Íµ¨Ìï¥Ïïº Ìï† ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄ Ïó∞ÏÇ∞
       int lastPage;
   	   int currentnumPage=0; // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÍ∞Ä Î™áÎ≤àÏß∏ Î¨∂ÏùåÏù∏ÏßÄ(Ïù¥Ï†Ñ,Îã§Ïùå Íµ¨ÌòÑÏùÑ ÏúÑÌï®)
   	   int lastnumPage=0; // ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄÍ∞Ä Î™áÎ≤àÏß∏ Î¨∂ÏùåÏù∏ÏßÄ(ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄÏóêÏÑú Îã§ÏùåÏù¥ ÎÇòÏò§ÏßÄ ÏïäÎèÑÎ°ù ÌïòÍ∏∞ ÏúÑÌï®)
   	   
   	   lastPage = qnaDao.selectQnaListLastPage(ROW_PER_PAGE);
	   
   %>
    <ul class="pagination body-back-color">
    <%
    	if(currentPage!=1){
    %>
    		<li class="page-item"><a class="page-link" href="<%=request.getContextPath() %>/selectQnaList.jsp?currentPage=<%=1 %>"><<</a></li>
    <%	
    	}
    	if(currentPage%ROW_PER_PAGE==0){ // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÍ∞Ä Î™áÎ≤àÏß∏ Î¨∂ÏùåÏù∏ÏßÄ
    		currentnumPage =(currentPage/ROW_PER_PAGE)-1;
    	} else{
    		currentnumPage = currentPage/ROW_PER_PAGE;
    	}
   	%>
    <%
    	if((currentnumPage)>0){ // Ïù¥Ï†Ñ
    %>
    		<li class="page-item"><a class="page-link" href="<%=request.getContextPath() %>/selectQnaList.jsp?currentPage=<%=ROW_PER_PAGE*(currentnumPage-1)+1 %>"><</a></li>
    <%
    	}
    
	    for(int i=0;i<ROW_PER_PAGE;i++){ // Ï§ëÍ∞Ñ Î≤àÌò∏Îì§
			if(lastPage>=(ROW_PER_PAGE*currentnumPage)+i+1){
				if(currentPage == (ROW_PER_PAGE*currentnumPage)+i+1){
					%>
						<li class="page-item active"><a class="page-link" href="<%=request.getContextPath() %>/selectQnaList.jsp?currentPage=<%=(ROW_PER_PAGE*currentnumPage)+i+1 %>"><%=(ROW_PER_PAGE*currentnumPage)+i+1 %></a></li>
					<%
				} else{
					%>
			   		  	<li class="page-item"><a class="page-link" href="<%=request.getContextPath() %>/selectQnaList.jsp?currentPage=<%=(ROW_PER_PAGE*currentnumPage)+i+1 %>"><%=(ROW_PER_PAGE*currentnumPage)+i+1 %></a></li>
			   		<%	
				}
			}
		}
	    
    	if(lastPage%ROW_PER_PAGE==0){ // ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄÍ∞Ä Î™áÎ≤àÏß∏ Î¨∂ÏùåÏù∏ÏßÄ
    		lastnumPage =(lastPage/ROW_PER_PAGE)-1;
    	} else{
    		lastnumPage = lastPage/ROW_PER_PAGE;
    	}
    	
    	if(lastnumPage>currentnumPage){
    %>
    		<li class="page-item"><a class="page-link" href="<%=request.getContextPath() %>/selectQnaList.jsp?currentPage=<%=ROW_PER_PAGE*(currentnumPage+1)+1 %>">></a></li>
    <%
    	}
    	if(currentPage!=lastPage && lastPage!=0){
    %>
    		<li class="page-item"><a class="page-link" href="<%=request.getContextPath() %>/selectQnaList.jsp?currentPage=<%=lastPage %>">>></a></li>
    <%
    	}
    %>
	</ul>
	</div>
	
	<!-- footer -->
	<div>
      <jsp:include page="/partial/footer.jsp"></jsp:include>
   </div>
   
	<script>
		$('#insertBtn').click(function(){
			// Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏßàÎ¨∏ ÏÉùÏÑ±ÌèºÏúºÎ°ú Ïù¥Îèô
			$('#insertQnaForm').submit();
		});
	</script>
</body>
</html>